<!DOCTYPE html>
<html>
<head>
    <title>Billing System Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; background: white; padding: 20px; border-radius: 8px; margin: 0 auto; }
        .button { 
            background: #007acc; color: white; border: none; padding: 10px 20px; 
            margin: 10px 0; border-radius: 5px; cursor: pointer; font-size: 16px; display: inline-block;
        }
        .button:disabled { opacity: 0.6; cursor: not-allowed; }
        .success { background: #d4edda; padding: 15px; margin: 10px 0; border-radius: 5px; color: #155724; }
        .error { background: #f8d7da; padding: 15px; margin: 10px 0; border-radius: 5px; color: #721c24; }
        .warning { background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 5px; color: #856404; }
        .log { background: #f8f8f8; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
        .plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .plan-card { border: 2px solid #ddd; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .plan-card:hover { border-color: #007acc; }
        .plan-card.selected { border-color: #007acc; background-color: #f0f8ff; }
        .card-element { 
            border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin: 10px 0;
            background: white; min-height: 40px;
        }
        input, select { 
            width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; 
            border-radius: 4px; font-size: 16px; box-sizing: border-box;
        }
        h1, h2 { color: #333; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Billing System Test</h1>
        
        <div class="warning">
            <strong>Test Mode:</strong> Use test card 4242 4242 4242 4242 with any future expiry and any CVC.
        </div>

        <h2>1. Authentication Test</h2>
        <input type="email" id="email" placeholder="Email" value="test@test.com">
        <input type="password" id="password" placeholder="Password" value="password123">
        <button class="button" onclick="testLogin()">Login & Get Token</button>
        
        <div id="auth-status" class="status"></div>

        <h2>2. Current Subscription</h2>
        <button class="button" onclick="getCurrentSubscription()" id="get-sub-btn">Check Current Subscription</button>
        <div id="subscription-status"></div>

        <h2>3. Stripe Test</h2>
        <button class="button" onclick="testStripe()">Test Stripe Connection</button>
        <div id="stripe-status"></div>

        <h2>4. Choose Plan</h2>
        <div class="plan-grid">
            <div class="plan-card" data-plan="starter" onclick="selectPlan('starter')">
                <h3>Starter - $29/month</h3>
                <ul>
                    <li>Up to 3 agents</li>
                    <li>1,000 tickets/month</li>
                    <li>Email support</li>
                </ul>
            </div>
            <div class="plan-card" data-plan="growth" onclick="selectPlan('growth')">
                <h3>Growth - $59/month</h3>
                <ul>
                    <li>Up to 10 agents</li>
                    <li>5,000 tickets/month</li>
                    <li>Chat support</li>
                </ul>
            </div>
            <div class="plan-card" data-plan="business" onclick="selectPlan('business')">
                <h3>Business - $99/month</h3>
                <ul>
                    <li>Unlimited agents</li>
                    <li>Unlimited tickets</li>
                    <li>Priority support</li>
                </ul>
            </div>
        </div>

        <div id="selected-plan" class="status" style="display: none;"></div>

        <h2>5. Payment Test</h2>
        <div id="card-element" class="card-element"></div>
        <button class="button" onclick="testPayment()" id="pay-btn" disabled>Test Subscription Creation</button>
        
        <div id="payment-status"></div>

        <h2>Logs</h2>
        <div id="logs" class="log"></div>
    </div>

    <script>
        let authToken = null;
        let selectedPlanId = null;
        let stripe = null;
        let cardElement = null;

        // Initialize Stripe
        document.addEventListener('DOMContentLoaded', function() {
            const STRIPE_KEY = 'pk_test_51Rote9QKQnR8VR9RyKR30jpkeGwejAbZyoWi6vZ5P1VVhfxggFLAnc4GXPA3prBAfylMZxGMaCZUhaWOEA5zzjHc00UbupmGtJ';
            stripe = Stripe(STRIPE_KEY);
            
            const elements = stripe.elements();
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        '::placeholder': {
                            color: '#aab7c4',
                        },
                    },
                },
            });
            
            cardElement.mount('#card-element');
            log('üöÄ Billing test page loaded with Stripe');
        });

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log('üîê Testing login...');
            
            try {
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    log('‚úÖ Login successful');
                    showStatus('auth-status', '‚úÖ Authenticated successfully', 'success');
                    document.getElementById('get-sub-btn').disabled = false;
                } else {
                    log('‚ùå Login failed: ' + data.error);
                    showStatus('auth-status', '‚ùå Login failed: ' + data.error, 'error');
                }
            } catch (error) {
                log('‚ùå Login error: ' + error.message);
                showStatus('auth-status', '‚ùå Login error: ' + error.message, 'error');
            }
        }

        async function getCurrentSubscription() {
            if (!authToken) {
                showStatus('subscription-status', '‚ùå Please login first', 'error');
                return;
            }
            
            log('üìä Checking current subscription...');
            
            try {
                const response = await fetch('http://localhost:3001/api/billing/subscription', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Subscription data retrieved');
                    let status = `<strong>Current Plan:</strong> ${data.plan}<br>`;
                    if (data.subscription) {
                        status += `<strong>Status:</strong> ${data.subscription.status}<br>`;
                        status += `<strong>Next Billing:</strong> ${new Date(data.subscription.currentPeriodEnd * 1000).toLocaleDateString()}`;
                    } else {
                        status += `<strong>Status:</strong> No active subscription`;
                    }
                    showStatus('subscription-status', status, 'success');
                } else {
                    log('‚ùå Failed to get subscription: ' + data.error);
                    showStatus('subscription-status', '‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                log('‚ùå Subscription check error: ' + error.message);
                showStatus('subscription-status', '‚ùå ' + error.message, 'error');
            }
        }

        async function testStripe() {
            log('üîß Testing Stripe connection...');
            
            try {
                const response = await fetch('http://localhost:3001/api/billing/test-stripe');
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Stripe connection successful');
                    showStatus('stripe-status', '‚úÖ Stripe is properly configured and connected', 'success');
                } else {
                    log('‚ùå Stripe connection failed: ' + data.error);
                    showStatus('stripe-status', '‚ùå Stripe error: ' + data.error, 'error');
                }
            } catch (error) {
                log('‚ùå Stripe test error: ' + error.message);
                showStatus('stripe-status', '‚ùå ' + error.message, 'error');
            }
        }

        function selectPlan(planId) {
            // Remove previous selection
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new plan
            document.querySelector(`[data-plan="${planId}"]`).classList.add('selected');
            selectedPlanId = planId;
            
            log(`üìã Selected plan: ${planId}`);
            showStatus('selected-plan', `‚úÖ Selected plan: ${planId.charAt(0).toUpperCase() + planId.slice(1)}`, 'success');
            
            document.getElementById('pay-btn').disabled = !authToken || !selectedPlanId;
        }

        async function testPayment() {
            if (!authToken || !selectedPlanId) {
                showStatus('payment-status', '‚ùå Please login and select a plan first', 'error');
                return;
            }
            
            log('üí≥ Testing payment with test card...');
            showStatus('payment-status', '‚è≥ Processing payment...', 'warning');
            
            try {
                // Create payment method
                const { error: paymentError, paymentMethod } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                });
                
                if (paymentError) {
                    log('‚ùå Payment method error: ' + paymentError.message);
                    showStatus('payment-status', '‚ùå ' + paymentError.message, 'error');
                    return;
                }
                
                log('üí≥ Payment method created: ' + paymentMethod.id);
                
                // Create subscription
                const response = await fetch('http://localhost:3001/api/billing/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        plan: selectedPlanId,
                        paymentMethodId: paymentMethod.id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Subscription created successfully');
                    let message = '‚úÖ Subscription created successfully!<br>';
                    message += `<strong>Subscription ID:</strong> ${data.subscriptionId}<br>`;
                    
                    if (data.clientSecret) {
                        log('üîí Confirming payment...');
                        const { error: confirmError } = await stripe.confirmCardPayment(data.clientSecret);
                        
                        if (confirmError) {
                            log('‚ùå Payment confirmation failed: ' + confirmError.message);
                            message += '<br>‚ùå Payment confirmation failed: ' + confirmError.message;
                            showStatus('payment-status', message, 'error');
                        } else {
                            log('‚úÖ Payment confirmed successfully');
                            message += '<br>‚úÖ Payment confirmed successfully';
                            showStatus('payment-status', message, 'success');
                        }
                    } else {
                        showStatus('payment-status', message, 'success');
                    }
                    
                    // Refresh subscription status
                    setTimeout(getCurrentSubscription, 2000);
                    
                } else {
                    log('‚ùå Subscription creation failed: ' + data.error);
                    showStatus('payment-status', '‚ùå ' + data.error + (data.details ? '<br>' + data.details : ''), 'error');
                }
                
            } catch (error) {
                log('‚ùå Payment error: ' + error.message);
                showStatus('payment-status', '‚ùå ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>